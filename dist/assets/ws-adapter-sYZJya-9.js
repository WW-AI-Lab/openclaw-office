var u=Object.defineProperty;var h=(n,t,e)=>t in n?u(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var c=(n,t,e)=>h(n,typeof t!="symbol"?t+"":t,e);const a=class a{constructor(t,e){c(this,"handlers",new Set);c(this,"unsubscribers",[]);this.wsClient=t,this.rpcClient=e}async connect(){for(const t of a.WATCHED_EVENTS){const e=this.wsClient.onEvent(t,i=>{for(const r of this.handlers)r(t,i)});this.unsubscribers.push(e)}}disconnect(){for(const t of this.unsubscribers)t();this.unsubscribers=[],this.handlers.clear()}onEvent(t){return this.handlers.add(t),()=>{this.handlers.delete(t)}}async chatHistory(t){return this.rpcClient.request("chat.history",t?{sessionKey:t}:{})}async chatSend(t){await this.rpcClient.request("chat.send",{sessionKey:t.sessionKey,message:t.text,deliver:!1,idempotencyKey:crypto.randomUUID()})}async chatAbort(t){await this.rpcClient.request("chat.abort",{sessionKey:t})}async sessionsList(){return this.rpcClient.request("sessions.list")}async sessionsPreview(t){return this.rpcClient.request("sessions.preview",{sessionKey:t})}async channelsStatus(){const t=await this.rpcClient.request("channels.status",{probe:!0});return g(t)}async channelsLogout(t,e){return this.rpcClient.request("channels.logout",{channel:t,accountId:e})}async webLoginStart(t){return this.rpcClient.request("web.login.start",{force:t})}async webLoginWait(){return this.rpcClient.request("web.login.wait")}async skillsStatus(){const t=await this.rpcClient.request("skills.status");return p(t.skills??[])}async skillsInstall(t,e){return this.rpcClient.request("skills.install",{name:t,installId:e})}async skillsUpdate(t,e){return this.rpcClient.request("skills.update",{skillKey:t,...e})}async cronList(){return(await this.rpcClient.request("cron.list")).jobs??[]}async cronAdd(t){return this.rpcClient.request("cron.add",t)}async cronUpdate(t,e){return this.rpcClient.request("cron.update",{id:t,patch:e})}async cronRemove(t){await this.rpcClient.request("cron.remove",{id:t})}async cronRun(t){await this.rpcClient.request("cron.run",{id:t})}async agentsList(){return this.rpcClient.request("agents.list")}async agentsCreate(t){return this.rpcClient.request("agents.create",t)}async agentsUpdate(t){return this.rpcClient.request("agents.update",t)}async agentsDelete(t){return this.rpcClient.request("agents.delete",t)}async agentsFilesList(t){return this.rpcClient.request("agents.files.list",{agentId:t})}async agentsFilesGet(t,e){return this.rpcClient.request("agents.files.get",{agentId:t,name:e})}async agentsFilesSet(t,e,i){return this.rpcClient.request("agents.files.set",{agentId:t,name:e,content:i})}async toolsCatalog(){return this.rpcClient.request("tools.catalog")}async usageStatus(){return this.rpcClient.request("usage.status")}async configGet(){return this.rpcClient.request("config.get")}async configPatch(t,e){return this.rpcClient.request("config.patch",{raw:t,...e?{baseHash:e}:{}})}async configSchema(){return this.rpcClient.request("config.schema")}async statusSummary(){const t=this.wsClient.getSnapshot(),e=this.wsClient.getServerInfo();return{version:e==null?void 0:e.version,port:18789,uptime:(t==null?void 0:t.uptimeMs)!=null?Math.floor(t.uptimeMs/1e3):void 0,mode:"local",configPath:t==null?void 0:t.configPath}}async updateRun(t){return this.rpcClient.request("update.run",t??{})}};c(a,"WATCHED_EVENTS",["agent","chat","presence","health","heartbeat","cron","shutdown"]);let l=a;function d(n){return n.error??n.lastError??void 0?"error":n.connected===!0?"connected":n.connected===!1?n.running?"connecting":"disconnected":n.running&&n.linked!==!1&&n.configured!==!1?"connected":n.running?"connecting":"disconnected"}function g(n){const t=n.channelAccounts??{},e=n.channelLabels??{},i=[];for(const[r,o]of Object.entries(t))for(const s of o)!s.accountId&&o.length===0||i.push({id:s.accountId?`${r}:${s.accountId}`:r,type:r,name:s.name??e[r]??r,status:d(s),accountId:s.accountId,error:s.error??s.lastError??void 0,configured:s.configured,linked:s.linked,running:s.running,lastConnectedAt:s.lastConnectedAt,lastMessageAt:s.lastMessageAt,reconnectAttempts:s.reconnectAttempts,mode:s.mode});return i}function p(n){return n.map(t=>({id:t.skillKey??"",slug:t.skillKey??"",name:t.name??t.skillKey??"",description:t.description??"",enabled:!t.disabled,icon:t.emoji??"ðŸ“¦",version:t.version??"",author:t.author,isCore:t.core,isBundled:t.bundled,config:t.config,source:t.source,homepage:t.homepage,primaryEnv:t.primaryEnv,always:t.always,eligible:t.eligible,blockedByAllowlist:t.blockedByAllowlist,requirements:t.requirements,missing:t.missing,installOptions:t.install,configChecks:t.configChecks}))}export{l as WsAdapter};
